

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Quant Factors &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '1.6_quant_factors';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Event Study" href="1.7_event_study.html" />
    <link rel="prev" title="Contrarian Trading" href="1.5_contrarian_trading.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1.1_stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.2_jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.3_fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.4_fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.5_contrarian_trading.html">Contrarian Trading</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.7_event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.1_economic_indicators.html">Economic Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.2_regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.3_time_series.html">Time Series Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.4_approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.5_economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.1_term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.2_bond_returns.html">Interest Rate Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.3_options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.4_value_at_risk.html">Value at Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.5_covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.6_market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.7_event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="4.1_network_graphs.html">Supply Chain Network Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="4.2_community_detection.html">Industry Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="4.3_graph_centrality.html">Input-Output Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="4.4_link_prediction.html">Product Market Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="4.5_spatial_regression.html">Earnings Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="5.1_fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="5.2_management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="5.3_business_textual.html">Business Textual Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.1_classification_models.html">Machine Learning: Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.2_regression_models.html">Machine Learning: Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.3_deep_learning.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.4_convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.5_recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.6_reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="6.7_language_modeling.html">Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="7.1_large_language_models.html">Large Language Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="7.2_llm_finetuning.html">LLM Fine-tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="7.3_llm_prompting.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="7.4_llm_agents.html">LLM Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/financial-data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/financial-data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2F1.6_quant_factors.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/1.6_quant_factors.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Quant Factors</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-investing">Factor investing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-markets-hypothesis">Adaptive Markets Hypothesis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-zoo">Factor Zoo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#past-prices">Past prices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity">Liquidity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentals">Fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#earnings-estimates">Earnings Estimates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backtests">Backtests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-analysis">Cluster analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hiearchical-clustering">Hiearchical clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k-means-clustering">K-means clustering</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="quant-factors">
<h1>Quant Factors<a class="headerlink" href="#quant-factors" title="Permalink to this heading">#</a></h1>
<p><em>Quants do it with models</em> - Anonymous</p>
<p>Factor investing is a systematic approach to asset pricing and portfolio management based on the premise that various risk factors drive asset returns. Factor-based investing recognizes that besides broad market exposure, additional systematic risks—such as value, momentum, and volatility—play a crucial role in determining returns. This framework has evolved over time, beginning with early models like the Capital Asset Pricing Model (CAPM) and expanding to multifactor models, behavioral theories, and adaptive market perspectives. This analysis explores the empirical performance of different factor strategies, and the methodologies used to evaluate them. We also examine historical backtests and employ clustering techniques to group similar investment strategies, seeking to identify style factors and construct effective benchmarks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span><span class="p">,</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">dendrogram</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_samples</span><span class="p">,</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">RedisDB</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BusDay</span><span class="p">,</span> <span class="n">Stocks</span><span class="p">,</span> <span class="n">Benchmarks</span><span class="p">,</span> <span class="n">Signals</span><span class="p">,</span> <span class="n">SignalsFrame</span><span class="p">,</span>
                              <span class="n">CRSP</span><span class="p">,</span> <span class="n">PSTAT</span><span class="p">,</span> <span class="n">IBES</span><span class="p">,</span> <span class="n">CRSPBuffer</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">finds.backtesting</span> <span class="kn">import</span> <span class="n">BackTest</span><span class="p">,</span> <span class="n">univariate_sorts</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">CRSP_DATE</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">VERBOSE</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>


<span class="c1">#%matplotlib qt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LAST_DATE</span> <span class="o">=</span> <span class="n">CRSP_DATE</span>
<span class="c1"># open connections</span>
<span class="n">imgdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
<span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">rdb</span> <span class="o">=</span> <span class="n">RedisDB</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">])</span>
<span class="n">bd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">crsp</span> <span class="o">=</span> <span class="n">CRSP</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">rdb</span><span class="o">=</span><span class="n">rdb</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">pstat</span> <span class="o">=</span> <span class="n">PSTAT</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bench</span> <span class="o">=</span> <span class="n">Benchmarks</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">Signals</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">ibes</span> <span class="o">=</span> <span class="n">IBES</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">BackTest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">bench</span><span class="p">,</span> <span class="s1">&#39;RF&#39;</span><span class="p">,</span> <span class="n">LAST_DATE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">outdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;output&#39;</span>
</pre></div>
</div>
</div>
</div>
<section id="factor-investing">
<h2>Factor investing<a class="headerlink" href="#factor-investing" title="Permalink to this heading">#</a></h2>
<p>Factor investing posits that asset returns are driven by exposure to specific risk factors, which determine their risk premiums. The market itself is an investable factor, as described by the Capital Asset Pricing Model (CAPM), which asserts that market exposure is the sole driver of asset returns. However, additional factors such as interest rates, value-growth investing, low volatility strategies, and momentum portfolios have been widely recognized. Macroeconomic factors, including inflation and economic growth, also influence asset returns. Assets exhibit varying degrees of exposure to these risk factors, with greater exposure leading to higher risk premiums. Essentially, assets can be viewed as bundles of different factor exposures.</p>
<p>Early multifactor models include Stephen Ross’s (1976) Arbitrage Pricing Theory (APT), which argues that risk factors cannot be arbitraged or diversified away, and Robert Merton’s Intertemporal Capital Asset Pricing Model (ICAPM), which accounts for investors hedging risky positions over multiple time periods. Additionally, behavioral finance theories suggest that factor premiums arise due to investor biases, such as overreaction, underreaction, and bounded rationality.</p>
<section id="adaptive-markets-hypothesis">
<h3>Adaptive Markets Hypothesis<a class="headerlink" href="#adaptive-markets-hypothesis" title="Permalink to this heading">#</a></h3>
<p>Andrew Lo’s (2004) <em>Adaptive Markets Hypothesis</em> proposes that financial markets are shaped by principles of evolutionary biology rather than fixed physical laws. This perspective suggests that investment performance fluctuates as the financial ecosystem and market conditions evolve. Lo advocates studying financial markets by analyzing different “species” of investors—individuals and institutions that share common traits—and tracking their size, growth, interactions, and behavioral tendencies.</p>
</section>
<section id="factor-zoo">
<h3>Factor Zoo<a class="headerlink" href="#factor-zoo" title="Permalink to this heading">#</a></h3>
<p>John Cochrane (2011) coined the term <em>Factor Zoo</em> to highlight the rapid proliferation of newly identified factors in academic research. In response, Green, Hand, and Zhang (2017) systematically examined nearly 100 firm characteristic factors, addressing issues such as microcap stock overweighting and data snooping biases. Their study assessed the predictive power of these factors across different time periods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># preload monthly stocks data</span>
<span class="n">monthly</span> <span class="o">=</span> <span class="n">CRSPBuffer</span><span class="p">(</span><span class="n">stocks</span><span class="o">=</span><span class="n">crsp</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;retx&#39;</span><span class="p">,</span> <span class="s1">&#39;prc&#39;</span><span class="p">],</span>
                     <span class="n">beg</span><span class="o">=</span><span class="mi">19251201</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">CRSP_DATE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># signals to flip signs when forming spread portfolios</span>
<span class="n">leverage</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mom1m&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mom36m&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pricedelay&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;absacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;agr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;chcsho&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;egr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;aeavol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stdacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stdcf&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;secured&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;maxret&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ill&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;zerotrade&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cashpr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;chinv&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;invest&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;idiovol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;retvol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Helper functions</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to lag yearly characteristics</span>
<span class="k">def</span> <span class="nf">as_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">nlags</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dataframe with {nlags} of column {var}, same {key} value in row&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>      <span class="c1"># first col: not shifted</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlags</span><span class="p">):</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># next col: shifted i+1</span>
        <span class="n">prev</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>   <span class="c1"># require same {key} value</span>
        <span class="n">out</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rolling window of returns</span>
<span class="k">def</span> <span class="nf">as_rolling</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;join next dataframe to a sliding window with fixed number of columns&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">width</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>          <span class="c1"># if wider than width</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="n">width</span><span class="p">):]</span>  <span class="c1">#    then drop first cols</span>
    <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>                                     <span class="c1"># drop empty rows</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pipeline to run backtest</span>
<span class="k">def</span> <span class="nf">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">:</span> <span class="n">BackTest</span><span class="p">,</span>
                      <span class="n">stocks</span><span class="p">:</span> <span class="n">Stocks</span><span class="p">,</span>
                      <span class="n">holdings</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
                      <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">benchnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                      <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;wrapper to run a backtest pipeline</span>

<span class="sd">    Args:</span>
<span class="sd">      backtest: To compute backtest results</span>
<span class="sd">      stocks: Where securities returns can be retrieved from (e.g. CRSP)</span>
<span class="sd">      holdings: dict (key int date) of Series holdings (key permno)</span>
<span class="sd">      label: Label of signal to backtest</span>
<span class="sd">      benchnames: Names of benchmarks to attribute portfolio performance</span>
<span class="sd">      overlap: Number of overlapping holdings to smooth</span>
<span class="sd">      num: Figure num to plot to</span>

<span class="sd">    Returns:</span>
<span class="sd">      DataFrame of performance returns in rows</span>

<span class="sd">    Notes:</span>
<span class="sd">      graph and summary statistics are output to jpg and (appended) html</span>
<span class="sd">      backtest object updated with performance and attribution data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">holdings</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">)</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">benchnames</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>\
              <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">outdir</span><span class="p">:</span>
        <span class="c1"># performance metrics from backtest to output</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;excess&#39;</span><span class="p">,</span> <span class="s1">&#39;appraisal&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;welch-t&#39;</span><span class="p">,</span> <span class="s1">&#39;welch-p&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;hr&gt;&lt;h2&gt;</span><span class="si">{</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="si">}</span><span class="s2">&lt;/h2&gt;</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">excess</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                        <span class="nb">max</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">excess</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                        <span class="n">benchnames</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:12s}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Annualized&quot;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:12s}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/pre&gt;&lt;p&gt;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="past-prices">
<h3>Past prices<a class="headerlink" href="#past-prices" title="Permalink to this heading">#</a></h3>
<p>Momentum and dividend yield data are sourced from CRSP monthly records</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19251231</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">intervals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mom12m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span>
             <span class="s1">&#39;mom36m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span>
             <span class="s1">&#39;mom6m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
             <span class="s1">&#39;mom1m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">past</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rebaldates</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">past</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">rebaldates</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="n">past</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">beg1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">past</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="c1"># require data available as of start month and end month (universe)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                          <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                          <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                          <span class="n">date</span><span class="o">=</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">]])</span> <span class="c1"># append rows</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19270101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chmom&#39;</span><span class="p">,</span> <span class="s1">&#39;divyld&#39;</span><span class="p">,</span> <span class="s1">&#39;indmom&#39;</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">beg1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">beg2</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                          <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                          <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                          <span class="n">date</span><span class="o">=</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                         <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                         <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                         <span class="n">date</span><span class="o">=</span><span class="n">end2</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg2</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;divyld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_divamt</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span>\
                           <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;divamt&#39;</span><span class="p">]</span>\
                           <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">])</span>\
                           <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chmom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom2&#39;</span><span class="p">]</span>

        <span class="c1"># 6-month two-digit sic industry momentum (group means of &#39;mom1&#39;)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sic2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;siccd&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sic2&#39;</span><span class="p">])[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>\
                     <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mom1&#39;</span><span class="p">:</span> <span class="s1">&#39;indmom&#39;</span><span class="p">}),</span>
                     <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sic2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end2&#39;</span><span class="p">])</span>\
                   <span class="p">[[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>   <span class="c1"># save signal values to sql</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 4/4 [47:03&lt;00:00, 705.93s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19260101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mom12m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom6m&#39;</span><span class="p">,</span> <span class="s1">&#39;chmom&#39;</span><span class="p">,</span> <span class="s1">&#39;indmom&#39;</span><span class="p">,</span> <span class="s1">&#39;divyld&#39;</span><span class="p">,</span> <span class="s1">&#39;mom1m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom36m&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">minprc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 7/7 [22:01&lt;00:00, 188.74s/it]
</pre></div>
</div>
<img alt="_images/5b0b292dc148897991d47373ee77759ed533537a63f1969fbbaa1a849ede1990.png" src="_images/5b0b292dc148897991d47373ee77759ed533537a63f1969fbbaa1a849ede1990.png" />
<img alt="_images/893b5b8c9e6464fcde8940c41b9221d82818db36a316c8998318702bca67821b.png" src="_images/893b5b8c9e6464fcde8940c41b9221d82818db36a316c8998318702bca67821b.png" />
<img alt="_images/11078450ca7695ccf2d4f4cf39598b82e8723ecbc7cd7a647fecb4b77c7e3d00.png" src="_images/11078450ca7695ccf2d4f4cf39598b82e8723ecbc7cd7a647fecb4b77c7e3d00.png" />
<img alt="_images/3c0a4f50844a517110a8e4d1af8cd9c5f1b4dc52d0e1a02b4eac85c596fda165.png" src="_images/3c0a4f50844a517110a8e4d1af8cd9c5f1b4dc52d0e1a02b4eac85c596fda165.png" />
<img alt="_images/c2d6cc544f63e59362a66461d13891ac89c7b18c0f414403966186d77647e2d8.png" src="_images/c2d6cc544f63e59362a66461d13891ac89c7b18c0f414403966186d77647e2d8.png" />
<img alt="_images/d53de64fda97f090854c9b8558689399254e396cba64aa6f7eed970e5858dac6.png" src="_images/d53de64fda97f090854c9b8558689399254e396cba64aa6f7eed970e5858dac6.png" />
<img alt="_images/959c3c586608efe35f76c107dc50af5faf94f03f1f3a19fd7ac65862d54f695a.png" src="_images/959c3c586608efe35f76c107dc50af5faf94f03f1f3a19fd7ac65862d54f695a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># helper to calculate beta, idiovol and price delay from weekly returns</span>
<span class="k">def</span> <span class="nf">regress</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;helper method to calculate beta, idiovol and price delay</span>

<span class="sd">    Args:</span>
<span class="sd">      x: equal-weighted market returns (in ascending time order)</span>
<span class="sd">      y: stock returns (in ascending time order).  NaN&#39;s will be discarded.</span>

<span class="sd">    Returns:</span>
<span class="sd">      beta: slope from regression on market returns and intercept</span>
<span class="sd">      idiovol: mean squared error of residuals</span>
<span class="sd">      pricedelay: increase of adjusted Rsq with four market lags over without</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A0</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>   <span class="c1"># univariate coeffs</span>
    <span class="n">sse0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">A0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sst0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sst0</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">sse0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">sse0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sst0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y4</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">n4</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y4</span><span class="p">)</span>         
    <span class="n">A4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n4</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A4</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y4</span><span class="p">))</span>  <span class="c1"># four lagged coeffs</span>
    <span class="n">sse4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y4</span> <span class="o">-</span> <span class="n">A4</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sst4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y4</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sst4</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sse4</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">sse4</span> <span class="o">/</span> <span class="p">(</span><span class="n">n4</span> <span class="o">-</span> <span class="mi">6</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sst4</span> <span class="o">/</span> <span class="p">(</span><span class="n">n4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="k">return</span> <span class="p">[</span><span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">sse0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span><span class="p">(</span><span class="n">R0</span> <span class="o">/</span> <span class="n">R4</span><span class="p">))</span> <span class="k">if</span> <span class="n">R0</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">R4</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Weekly price responses derived from CRSP daily records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19260101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">columns</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;idiovol&#39;</span><span class="p">,</span> <span class="s1">&#39;pricedelay&#39;</span><span class="p">]</span>
<span class="n">wd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">endweek</span><span class="o">=</span><span class="s1">&#39;Wed&#39;</span><span class="p">)</span>  <span class="c1"># custom weekly trading day calendar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span>    <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">52</span><span class="o">+</span><span class="mi">1</span>           <span class="c1"># up to 3 years of weekly returns</span>
<span class="n">minvalid</span> <span class="o">=</span> <span class="mi">52</span>               <span class="c1"># at least 52 weeks required to compute beta</span>
<span class="n">weekly</span>   <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>      <span class="c1"># rolling window of weekly stock returns</span>
<span class="n">mkt</span>      <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>      <span class="c1"># to queue equal-weighted market returns</span>
<span class="n">out</span>      <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># to accumulate final calculations</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;weekly&#39;</span><span class="p">)):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">begwk</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">mkt</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">mkt</span><span class="p">,</span>       <span class="c1"># rolling window of weekly mkt returns</span>
                     <span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">date</span><span class="p">]),</span>
                     <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">weekly</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">weekly</span><span class="p">,</span> <span class="c1"># rolling window of weekly stock returns</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">date</span><span class="p">),</span>
                        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span> 
    <span class="n">valid</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minvalid</span>  <span class="c1"># require min number weeks</span>
    <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">([</span><span class="n">regress</span><span class="p">(</span><span class="n">mkt</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">weekly</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
                           <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
        <span class="k">if</span> <span class="n">wd</span><span class="o">.</span><span class="n">ismonthend</span><span class="p">(</span><span class="n">date</span><span class="p">):</span> <span class="c1"># signal value from last week of month</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5165/5165 [31:49&lt;00:00,  2.70it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19290601</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 3/3 [07:48&lt;00:00, 156.06s/it]
</pre></div>
</div>
<img alt="_images/0be45ea8caf1d2b5b2a7f5cdaceea3c4f3824dec297031bf07233d9f6f7c905d.png" src="_images/0be45ea8caf1d2b5b2a7f5cdaceea3c4f3824dec297031bf07233d9f6f7c905d.png" />
<img alt="_images/e1f02c250658de47f7b9e13fba6d9a8972a0785b9d010ff30bcb4862efe8fcf0.png" src="_images/e1f02c250658de47f7b9e13fba6d9a8972a0785b9d010ff30bcb4862efe8fcf0.png" />
<img alt="_images/80ae54a88abe90cdd26ca9bd59a603d8d38aa8dc271b96b1880dec71b39a8316.png" src="_images/80ae54a88abe90cdd26ca9bd59a603d8d38aa8dc271b96b1880dec71b39a8316.png" />
</div>
</div>
</section>
<section id="liquidity">
<h3>Liquidity<a class="headerlink" href="#liquidity" title="Permalink to this heading">#</a></h3>
<p>Liquidity signals are derived from daily stock return data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19830601</span><span class="p">,</span> <span class="n">LAST_DATE</span>    <span class="c1"># nasdaq/volume from after 1982</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">,</span> <span class="s1">&#39;maxret&#39;</span><span class="p">,</span> <span class="s1">&#39;retvol&#39;</span><span class="p">,</span> <span class="s1">&#39;baspread&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dolvol&#39;</span><span class="p">,</span>
           <span class="s1">&#39;zerotrade&#39;</span><span class="p">,</span> <span class="s1">&#39;std_turn&#39;</span><span class="p">,</span> <span class="s1">&#39;turn&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dolvol</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">turn</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>    <span class="c1"># to average turn signal over rolling 3-months</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span> <span class="c1"># monthly rebalances</span>
<span class="n">chunksize</span> <span class="o">=</span> <span class="mi">12</span>        <span class="c1"># each chunk is 12 months (1 year)</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT permno, date, ret, askhi, bidlo, prc, vol, shrout &quot;</span>
         <span class="sa">f</span><span class="s2">&quot; FROM </span><span class="si">{</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="sa">f</span><span class="s2">&quot; WHERE date&gt;=</span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="sa">f</span><span class="s2">&quot;   AND date&lt;=</span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        <span class="c1"># retrieve a chunk</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;askhi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bidlo&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;askhi&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bidlo&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ldv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">])</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>            <span class="c1"># for each rebaldate in the chunk</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="s1">&#39;maxret&#39;</span><span class="p">})</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;retvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ldv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dv</span><span class="p">[</span><span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_turn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;countzero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            
        <span class="n">turn</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]],</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">turn</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;ndays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;zerotrade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;countzero&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">480000</span><span class="p">))</span>
                           <span class="o">*</span> <span class="mi">21</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">])</span>
    
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rebaldate</span> <span class="o">&lt;</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">end</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dolvol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]])</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dolvol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dolvol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>            
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 42/42 [25:56&lt;00:00, 37.05s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dolvol</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19830601</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 9/9 [09:46&lt;00:00, 65.17s/it]
</pre></div>
</div>
<img alt="_images/db19c58a365d2089fd6b417ca5a92de19d770e4cd87c4bcb3a2c85c75b7075a4.png" src="_images/db19c58a365d2089fd6b417ca5a92de19d770e4cd87c4bcb3a2c85c75b7075a4.png" />
<img alt="_images/2684ab47dbb557c2e9b98a942b83fb34d38d40017d783b49aed729044d6429b1.png" src="_images/2684ab47dbb557c2e9b98a942b83fb34d38d40017d783b49aed729044d6429b1.png" />
<img alt="_images/ad29d61dad29ce16c18c6aadf44e3b0e5c496330ca513d094d13f0bc8c83358d.png" src="_images/ad29d61dad29ce16c18c6aadf44e3b0e5c496330ca513d094d13f0bc8c83358d.png" />
<img alt="_images/4f6fe8afbc511a7b2c8e132e7c1ce87cc188cb1b362fc475a2ecc9d4b31a37ec.png" src="_images/4f6fe8afbc511a7b2c8e132e7c1ce87cc188cb1b362fc475a2ecc9d4b31a37ec.png" />
<img alt="_images/022a942fd59f36f56bdd5ad3af99bd4554e8cc5b15d5bebe5200ce6ca8099db9.png" src="_images/022a942fd59f36f56bdd5ad3af99bd4554e8cc5b15d5bebe5200ce6ca8099db9.png" />
<img alt="_images/95487e36cc6ef21477b62ee9e395bafbd76fc151d3640424d3e9c7794f356a81.png" src="_images/95487e36cc6ef21477b62ee9e395bafbd76fc151d3640424d3e9c7794f356a81.png" />
<img alt="_images/115752759814e0023dc786f04fcb3b86095bded9aa38858af0cd7c9eabaaaa55.png" src="_images/115752759814e0023dc786f04fcb3b86095bded9aa38858af0cd7c9eabaaaa55.png" />
<img alt="_images/c0fa17a560a6174ede981d553986dc3bce6dd84f7abc70dd7d588955135a808d.png" src="_images/c0fa17a560a6174ede981d553986dc3bce6dd84f7abc70dd7d588955135a808d.png" />
<img alt="_images/cbfe283b6234fa44d00eabf00a59293baab5e5bba12c4d88de9b19c86dd62c2c.png" src="_images/cbfe283b6234fa44d00eabf00a59293baab5e5bba12c4d88de9b19c86dd62c2c.png" />
</div>
</div>
</section>
<section id="fundamentals">
<h3>Fundamentals<a class="headerlink" href="#fundamentals" title="Permalink to this heading">#</a></h3>
<p>Fundamental signals are collected from Compustat, using both annual and quarterly datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;absacc&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="s1">&#39;agr&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;cashpr&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp&#39;</span><span class="p">,</span> <span class="s1">&#39;chcsho&#39;</span><span class="p">,</span>
           <span class="s1">&#39;chinv&#39;</span><span class="p">,</span> <span class="s1">&#39;depr&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;egr&#39;</span><span class="p">,</span> <span class="s1">&#39;ep&#39;</span><span class="p">,</span> <span class="s1">&#39;gma&#39;</span><span class="p">,</span> <span class="s1">&#39;grcapx&#39;</span><span class="p">,</span>
           <span class="s1">&#39;grltnoa&#39;</span><span class="p">,</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;invest&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;lgr&#39;</span> <span class="p">,</span>
           <span class="s1">&#39;pchdepr&#39;</span><span class="p">,</span> <span class="s1">&#39;pchgm_pchsale&#39;</span><span class="p">,</span> <span class="s1">&#39;pchquick&#39;</span><span class="p">,</span>
           <span class="s1">&#39;pchsale_pchinvt&#39;</span><span class="p">,</span> <span class="s1">&#39;pchsale_pchrect&#39;</span><span class="p">,</span> <span class="s1">&#39;pchsale_pchxsga&#39;</span><span class="p">,</span>
           <span class="s1">&#39;pchsaleinv&#39;</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">,</span> <span class="s1">&#39;quick&#39;</span><span class="p">,</span> <span class="s1">&#39;rd_sale&#39;</span><span class="p">,</span> <span class="s1">&#39;rd_mve&#39;</span><span class="p">,</span>
           <span class="s1">&#39;realestate&#39;</span><span class="p">,</span> <span class="s1">&#39;salecash&#39;</span><span class="p">,</span> <span class="s1">&#39;salerec&#39;</span><span class="p">,</span> <span class="s1">&#39;saleinv&#39;</span><span class="p">,</span> <span class="s1">&#39;secured&#39;</span><span class="p">,</span>
           <span class="s1">&#39;sgr&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;tang&#39;</span><span class="p">,</span> <span class="s1">&#39;bm_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;chatoia&#39;</span> <span class="p">,</span> <span class="s1">&#39;chpmia&#39;</span><span class="p">,</span>
           <span class="s1">&#39;pchcapx_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;chempia&#39;</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">]</span>
<span class="n">numlag</span> <span class="o">=</span> <span class="mi">6</span>       <span class="c1"># number of months to lag data for rebalance</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>   <span class="c1"># last data date</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve annual, keep [permno, datadate] with non null prccq if any</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">,</span> <span class="s1">&#39;fyear&#39;</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;act&#39;</span><span class="p">,</span> <span class="s1">&#39;che&#39;</span><span class="p">,</span> <span class="s1">&#39;lct&#39;</span><span class="p">,</span>
          <span class="s1">&#39;dlc&#39;</span><span class="p">,</span> <span class="s1">&#39;dltt&#39;</span><span class="p">,</span> <span class="s1">&#39;prcc_f&#39;</span><span class="p">,</span> <span class="s1">&#39;csho&#39;</span><span class="p">,</span> <span class="s1">&#39;invt&#39;</span><span class="p">,</span> <span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;ppent&#39;</span><span class="p">,</span>
          <span class="s1">&#39;dvt&#39;</span><span class="p">,</span> <span class="s1">&#39;ceq&#39;</span><span class="p">,</span> <span class="s1">&#39;txp&#39;</span><span class="p">,</span> <span class="s1">&#39;revt&#39;</span><span class="p">,</span> <span class="s1">&#39;cogs&#39;</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;aco&#39;</span><span class="p">,</span> <span class="s1">&#39;intan&#39;</span><span class="p">,</span>
          <span class="s1">&#39;ao&#39;</span><span class="p">,</span> <span class="s1">&#39;ap&#39;</span><span class="p">,</span> <span class="s1">&#39;lco&#39;</span><span class="p">,</span> <span class="s1">&#39;lo&#39;</span><span class="p">,</span> <span class="s1">&#39;capx&#39;</span><span class="p">,</span> <span class="s1">&#39;emp&#39;</span><span class="p">,</span> <span class="s1">&#39;ppegt&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="s1">&#39;xsga&#39;</span><span class="p">,</span> <span class="s1">&#39;xrd&#39;</span><span class="p">,</span> <span class="s1">&#39;fatb&#39;</span><span class="p">,</span> <span class="s1">&#39;fatl&#39;</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;indfmt = &#39;INDL&#39; &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND datafmt = &#39;STD&#39;&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND curcd = &#39;USD&#39; &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND popsrc = &#39;D&#39;&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND consol = &#39;C&#39;&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">))</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]))</span>  <span class="c1"># multi-index</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">datadate</span><span class="p">,</span> <span class="n">numlag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># precompute, and lag common metrics: mve_f avg_at sic2</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fyear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">10000</span>      <span class="c1"># can delete this</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prcc_f&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag2</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">lag</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cashpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dltt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;depr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dvt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;quick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rd_sale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xrd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rd_mve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xrd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;realestate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fatb&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fatl&#39;</span><span class="p">])</span> <span class="o">/</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                               <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;salecash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;salerec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;secured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dltt&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;tang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.715</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.547</span>
                <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.535</span><span class="p">)</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># changes: agr chcsho chinv egr gma egr grcapx grltnoa emp invest lgr</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;agr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chcsho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;egr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;gma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;grcapx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;grltnoa&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;intan&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ao&#39;</span><span class="p">]</span>
                      <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                      <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">]</span>
                      <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lo&#39;</span><span class="p">])</span>
                     <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;intan&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ao&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lo&#39;</span><span class="p">]))</span>
                    <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">])</span>
                       <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                          <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                          <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                          <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                          <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;hire&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;emp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;emp&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">])</span>
                   <span class="o">+</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                      <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">])</span>
                                       <span class="o">+</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchdepr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchgm_pchsale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">]))</span>
                         <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchquick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                    <span class="o">/</span> <span class="p">((</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchinvt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchrect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchxsga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsaleinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chato&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chpm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchcapx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute signals with alternative definitions: acc absacc cfp</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]))</span>
                <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">])</span>
                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]))</span>
                              <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                                 <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">])</span>
                                 <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">])</span>
                                 <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">])</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;oancf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;absacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pctacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">])</span>
<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># industry-adjusted</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bm_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;cfp&#39;</span><span class="p">,</span> <span class="s1">&#39;chatoia&#39;</span><span class="p">:</span> <span class="s1">&#39;chato&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chpmia&#39;</span><span class="p">:</span> <span class="s1">&#39;chpm&#39;</span><span class="p">,</span> <span class="s1">&#39;pchcapx_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;pchcapx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chempia&#39;</span><span class="p">:</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;mve_f&#39;</span><span class="p">}</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sic2&#39;</span><span class="p">,</span> <span class="s1">&#39;fyear&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fund</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">group</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span> <span class="c1">#[&#39;Mom&#39;]  #[&#39;ST_Rev(mo)&#39;]   #</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 44%|████▍     | 20/45 [29:40&lt;39:56, 95.88s/it] /home/terence/Dropbox/github/data-science-notebooks/finds/backtesting/backtest.py:310: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`). Consider using `matplotlib.pyplot.close()`.
  fig, (ax1, ax2) = plt.subplots(2, 1, sharex=True, clear=True,
100%|██████████| 45/45 [1:09:08&lt;00:00, 92.19s/it]
</pre></div>
</div>
<img alt="_images/794cb8a4544ce3bfb6a676d8e6c169d9e20228e54916e7281910a0cd3771489c.png" src="_images/794cb8a4544ce3bfb6a676d8e6c169d9e20228e54916e7281910a0cd3771489c.png" />
<img alt="_images/e1a24a36fea3104f13b92834950f5131159ce896d7c0539afb34125a82366128.png" src="_images/e1a24a36fea3104f13b92834950f5131159ce896d7c0539afb34125a82366128.png" />
<img alt="_images/14c282c826a5d2a69deefc024576328977e3c246ad839483c452df05b2ad52d3.png" src="_images/14c282c826a5d2a69deefc024576328977e3c246ad839483c452df05b2ad52d3.png" />
<img alt="_images/18ca627b6c3d11d1229219b64f1fbaa5a154aec9994fe65ac8c6fb6f9bb3871b.png" src="_images/18ca627b6c3d11d1229219b64f1fbaa5a154aec9994fe65ac8c6fb6f9bb3871b.png" />
<img alt="_images/f70c48f066076aca109ef9bfa9d2ce037361ebd38f28e0d6cc3c298484172d4a.png" src="_images/f70c48f066076aca109ef9bfa9d2ce037361ebd38f28e0d6cc3c298484172d4a.png" />
<img alt="_images/d5c0a8ea055b5eb226abddd31dbff5a16d3b594b46daaa0af850226e4ff3ac94.png" src="_images/d5c0a8ea055b5eb226abddd31dbff5a16d3b594b46daaa0af850226e4ff3ac94.png" />
<img alt="_images/17a0609da2b61b5994ecc581e66005898cbaacb007a46ea0920157e4eae59eed.png" src="_images/17a0609da2b61b5994ecc581e66005898cbaacb007a46ea0920157e4eae59eed.png" />
<img alt="_images/546d1fa8fa904ec51b3c34ca39527cf7f9a4fea7c9dc860b4396a6bb885fe673.png" src="_images/546d1fa8fa904ec51b3c34ca39527cf7f9a4fea7c9dc860b4396a6bb885fe673.png" />
<img alt="_images/93919e504ca9c9a01126c851788d4ef11d307c94e1e2c7df0e5e1d6ed0504465.png" src="_images/93919e504ca9c9a01126c851788d4ef11d307c94e1e2c7df0e5e1d6ed0504465.png" />
<img alt="_images/43d876eed86f09e369fa863c14caa2ba5140041324365c28c98b95fa76a30cbd.png" src="_images/43d876eed86f09e369fa863c14caa2ba5140041324365c28c98b95fa76a30cbd.png" />
<img alt="_images/ffe866fa6712a1863c212e471b76d525980287ba0b74f573f46c8a714a4a7c42.png" src="_images/ffe866fa6712a1863c212e471b76d525980287ba0b74f573f46c8a714a4a7c42.png" />
<img alt="_images/5282e107dae45a9f04f313e69d22cac5ccf47ae8aeffe7fe4521b6c28e326523.png" src="_images/5282e107dae45a9f04f313e69d22cac5ccf47ae8aeffe7fe4521b6c28e326523.png" />
<img alt="_images/c6d882d796a088aba1a5d144853aef997ad8ab707164faefe92f3e545bab195d.png" src="_images/c6d882d796a088aba1a5d144853aef997ad8ab707164faefe92f3e545bab195d.png" />
<img alt="_images/de406809bcbc68fdbe70d6eaaa81200301467fde6777f25384fa583ee02f0f0a.png" src="_images/de406809bcbc68fdbe70d6eaaa81200301467fde6777f25384fa583ee02f0f0a.png" />
<img alt="_images/4e53f18118d07316f33ea767b8b4c16888a72b6f66239ff762a4e76e86c6e9e5.png" src="_images/4e53f18118d07316f33ea767b8b4c16888a72b6f66239ff762a4e76e86c6e9e5.png" />
<img alt="_images/c1277747d19446a42d5ed4ecaea21087fbf4d0f09688dc53ec090ab335a28f2e.png" src="_images/c1277747d19446a42d5ed4ecaea21087fbf4d0f09688dc53ec090ab335a28f2e.png" />
<img alt="_images/7d68cff93c951105aaac7756a78255aff5ae071e3a7172b52226b66137252608.png" src="_images/7d68cff93c951105aaac7756a78255aff5ae071e3a7172b52226b66137252608.png" />
<img alt="_images/7932dfb9bee40434697ab65879929728381006df8042d2f3ca9cd03b8da6e984.png" src="_images/7932dfb9bee40434697ab65879929728381006df8042d2f3ca9cd03b8da6e984.png" />
<img alt="_images/6bbfd9766043054c861cd12f51f2c7a5c154dc76fd5fd28d00742e2f7024da88.png" src="_images/6bbfd9766043054c861cd12f51f2c7a5c154dc76fd5fd28d00742e2f7024da88.png" />
<img alt="_images/ad01880a780bb6cf5751a2e17da28d90b7d407b3f89f3936d215f3f3c695e651.png" src="_images/ad01880a780bb6cf5751a2e17da28d90b7d407b3f89f3936d215f3f3c695e651.png" />
<img alt="_images/0ee8b8487538fbd4304a6404d23a92b1a8fdf08068caf893731f358676e5ccca.png" src="_images/0ee8b8487538fbd4304a6404d23a92b1a8fdf08068caf893731f358676e5ccca.png" />
<img alt="_images/61346c0537fd699123c5cedbc5270fc50fb4de75dac4477f93213c93a787e284.png" src="_images/61346c0537fd699123c5cedbc5270fc50fb4de75dac4477f93213c93a787e284.png" />
<img alt="_images/a4e859c3dbbfa9b3b1c2a1d3415c4d8481eae2a802a4f78712c5b84f843d1fff.png" src="_images/a4e859c3dbbfa9b3b1c2a1d3415c4d8481eae2a802a4f78712c5b84f843d1fff.png" />
<img alt="_images/f05a17045d595721804140dfa2e6289f3eceb75d4e2e1fd8e86e3ba34bd149a0.png" src="_images/f05a17045d595721804140dfa2e6289f3eceb75d4e2e1fd8e86e3ba34bd149a0.png" />
<img alt="_images/d07b2397bd78cc3c084f9d0d38886103f6a8eec3ff7c79238d042e46ef9fbd90.png" src="_images/d07b2397bd78cc3c084f9d0d38886103f6a8eec3ff7c79238d042e46ef9fbd90.png" />
<img alt="_images/9a365222ca10561844d7acf8185d45899332d612afbd8a43b1e322063ec44356.png" src="_images/9a365222ca10561844d7acf8185d45899332d612afbd8a43b1e322063ec44356.png" />
<img alt="_images/5d0ae404d6dc129d9eaf9a6bd370825b3ebc6f4681451cdeb29e65e1b6c52def.png" src="_images/5d0ae404d6dc129d9eaf9a6bd370825b3ebc6f4681451cdeb29e65e1b6c52def.png" />
<img alt="_images/b8ff51acdf74ba9a7083d4cdd83fe9ac11eaeb10b0230a3088d4294f520b5538.png" src="_images/b8ff51acdf74ba9a7083d4cdd83fe9ac11eaeb10b0230a3088d4294f520b5538.png" />
<img alt="_images/75f301ec6c8571c25d98becb0a7166149cb6cb32b2bddc38753620218892acc7.png" src="_images/75f301ec6c8571c25d98becb0a7166149cb6cb32b2bddc38753620218892acc7.png" />
<img alt="_images/0ff08dc3c9a2f1c49bb93f842bd4834be684fcf6ed407ade03e75b494e21d0c0.png" src="_images/0ff08dc3c9a2f1c49bb93f842bd4834be684fcf6ed407ade03e75b494e21d0c0.png" />
<img alt="_images/df348a1a3856a5a1127288b756eb75f2f1735c85e87e6b71750d24b8bf76cadf.png" src="_images/df348a1a3856a5a1127288b756eb75f2f1735c85e87e6b71750d24b8bf76cadf.png" />
<img alt="_images/f71566649a9d00ae8f405088423613eac36a27f3199f7c5d06c4e3fb78850285.png" src="_images/f71566649a9d00ae8f405088423613eac36a27f3199f7c5d06c4e3fb78850285.png" />
<img alt="_images/89743a8c51946f728d6ea01a3fba8352852b22a24a5cbcff9c0c47df011b9a3e.png" src="_images/89743a8c51946f728d6ea01a3fba8352852b22a24a5cbcff9c0c47df011b9a3e.png" />
<img alt="_images/0572457fabe4ebcea1a790a7afab3edc86acb3b8ddbc2bd63eec2d134f5e8656.png" src="_images/0572457fabe4ebcea1a790a7afab3edc86acb3b8ddbc2bd63eec2d134f5e8656.png" />
<img alt="_images/8a57b6cf9f4b4d75bdd72ea065f4e546606b53f9a2ac6afc2f7247e31b746c5d.png" src="_images/8a57b6cf9f4b4d75bdd72ea065f4e546606b53f9a2ac6afc2f7247e31b746c5d.png" />
<img alt="_images/90ecf240d0b95409da9b5c2121a089b84cec544e4e81e5f167c967621365c54b.png" src="_images/90ecf240d0b95409da9b5c2121a089b84cec544e4e81e5f167c967621365c54b.png" />
<img alt="_images/4e83f63f3f0bfa2d5a41135fae0dbebfa751b30002d92ae63c6eea541d0aa734.png" src="_images/4e83f63f3f0bfa2d5a41135fae0dbebfa751b30002d92ae63c6eea541d0aa734.png" />
<img alt="_images/113a73a9cfc9726cdebb03df2b94166065d32445e126ba538df8ebd118a632b5.png" src="_images/113a73a9cfc9726cdebb03df2b94166065d32445e126ba538df8ebd118a632b5.png" />
<img alt="_images/cc93147c2e860afd1b201d7282b2c0e71379763b3ebcee1e55709d3e168a9719.png" src="_images/cc93147c2e860afd1b201d7282b2c0e71379763b3ebcee1e55709d3e168a9719.png" />
<img alt="_images/c3494b34abb4a2114237739cd5776887b9175759747b4b75e2ce35ac0bf5d86b.png" src="_images/c3494b34abb4a2114237739cd5776887b9175759747b4b75e2ce35ac0bf5d86b.png" />
<img alt="_images/3557e390e26b5dd77f42365ef4a24ba0f33a26d91538fe38d9fbeb259a583112.png" src="_images/3557e390e26b5dd77f42365ef4a24ba0f33a26d91538fe38d9fbeb259a583112.png" />
<img alt="_images/2d6126d179c2dc89d33750d39cad72fb3f8b85763b902b7dec1016a1784d9413.png" src="_images/2d6126d179c2dc89d33750d39cad72fb3f8b85763b902b7dec1016a1784d9413.png" />
<img alt="_images/df518679f17eaaf444e7473cda87fd3214b5a30626d0263d907fcdf84aabe21c.png" src="_images/df518679f17eaaf444e7473cda87fd3214b5a30626d0263d907fcdf84aabe21c.png" />
<img alt="_images/12f724bd4ca6bf251b1ca05423137a422bbf2ce36379b4a04de5a272bd62daaa.png" src="_images/12f724bd4ca6bf251b1ca05423137a422bbf2ce36379b4a04de5a272bd62daaa.png" />
<img alt="_images/f663e36a3883444521e67c5762eb5973e8ffd473f48eee01fae52dc89cfb9fca.png" src="_images/f663e36a3883444521e67c5762eb5973e8ffd473f48eee01fae52dc89cfb9fca.png" />
</div>
</div>
<p>Fundamental signals from Compustat Quarterly</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stdacc&#39;</span><span class="p">,</span> <span class="s1">&#39;stdcf&#39;</span><span class="p">,</span> <span class="s1">&#39;roavol&#39;</span><span class="p">,</span> <span class="s1">&#39;sgrvol&#39;</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">,</span> <span class="s1">&#39;chtx&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rsup&#39;</span><span class="p">,</span> <span class="s1">&#39;roaq&#39;</span><span class="p">,</span> <span class="s1">&#39;cash&#39;</span><span class="p">,</span> <span class="s1">&#39;nincr&#39;</span><span class="p">]</span>
<span class="n">numlag</span> <span class="o">=</span> <span class="mi">4</span>       <span class="c1"># require 4 month lag of fiscal data</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve quarterly, keep [permno, datadate] key with non null prccq</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">,</span> <span class="s1">&#39;actq&#39;</span><span class="p">,</span> <span class="s1">&#39;cheq&#39;</span><span class="p">,</span> <span class="s1">&#39;lctq&#39;</span><span class="p">,</span> <span class="s1">&#39;dlcq&#39;</span><span class="p">,</span> <span class="s1">&#39;saleq&#39;</span><span class="p">,</span> <span class="s1">&#39;prccq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;cshoq&#39;</span><span class="p">,</span> <span class="s1">&#39;atq&#39;</span><span class="p">,</span> <span class="s1">&#39;txtq&#39;</span><span class="p">,</span> <span class="s1">&#39;ppentq&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;datadate &gt; 0 &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;and datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">))</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;ibq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]))</span>
<span class="n">rebaldate</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">datadate</span><span class="p">,</span> <span class="n">numlag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute current and lagged: scf sacc roaq nincr cinvest cash rsup chtx</span>
<span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="s1">&#39;_saleq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;actq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;actq&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]))</span>
                <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lctq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lctq&#39;</span><span class="p">])</span>
                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlcq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlcq&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppentq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppentq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;roaq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag4</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag4</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rsup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cshoq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txtq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;txtq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each var: make dataframe of 15 lags (column names=[0,...,15])</span>
<span class="n">lags</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span> <span class="p">:</span> <span class="n">as_lags</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">,</span> <span class="s1">&#39;scf&#39;</span><span class="p">,</span> <span class="s1">&#39;roaq&#39;</span><span class="p">,</span> <span class="s1">&#39;rsup&#39;</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">,</span> <span class="s1">&#39;nincr&#39;</span><span class="p">]}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>                      <span class="c1"># lags[ninrc][i]=1 iff ibq</span>
    <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># increasing all prior qtrs</span>

    <span class="c1"># compute signals from the 15 lags</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;stdacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;stdcf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;roavol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;roaq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sgrvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;rsup&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">-</span>
                       <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">][[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># count number of consecutive increasing quarters</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;(-)&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10/10 [11:53&lt;00:00, 71.38s/it]
</pre></div>
</div>
<img alt="_images/5468bfd94ea93a4ad924754fc8ec3a794169d57834742444686b6b5566699a52.png" src="_images/5468bfd94ea93a4ad924754fc8ec3a794169d57834742444686b6b5566699a52.png" />
<img alt="_images/670de384250a0b3efac54dfbd1dcdf1f43e18f2ba9c90ec2fddd5079ce565c80.png" src="_images/670de384250a0b3efac54dfbd1dcdf1f43e18f2ba9c90ec2fddd5079ce565c80.png" />
<img alt="_images/cb232fa5e0c6c3e902650095e14fccabb6d8cb9a7ee859dc0dacf3a986adbb34.png" src="_images/cb232fa5e0c6c3e902650095e14fccabb6d8cb9a7ee859dc0dacf3a986adbb34.png" />
<img alt="_images/4ce2854fc980ffc0750c1d9a95d350787e5681b3b1f678a8e8afd06b00762869.png" src="_images/4ce2854fc980ffc0750c1d9a95d350787e5681b3b1f678a8e8afd06b00762869.png" />
<img alt="_images/a102d7b0c700880d3f477edd766540c3514be477dc3ffcb19ce130abdd1cea83.png" src="_images/a102d7b0c700880d3f477edd766540c3514be477dc3ffcb19ce130abdd1cea83.png" />
<img alt="_images/e9553fad78aa848eb0f3cad09e7e7c218df1d3f597b0e3aff1ec3e1ec125fb24.png" src="_images/e9553fad78aa848eb0f3cad09e7e7c218df1d3f597b0e3aff1ec3e1ec125fb24.png" />
<img alt="_images/8131e8f80a062536879bd17f43c65ef46a1024492fd46c9bdeec661e09435e99.png" src="_images/8131e8f80a062536879bd17f43c65ef46a1024492fd46c9bdeec661e09435e99.png" />
<img alt="_images/8447adfad8ef451e158be9cc2ae248d5d2955a9ccc9921321baa7e868b7460a3.png" src="_images/8447adfad8ef451e158be9cc2ae248d5d2955a9ccc9921321baa7e868b7460a3.png" />
<img alt="_images/97344d07bd1e95deee826c71d43947b2f3fc23f59b07ff91a6708c4c06fccc8e.png" src="_images/97344d07bd1e95deee826c71d43947b2f3fc23f59b07ff91a6708c4c06fccc8e.png" />
<img alt="_images/023f350e65cb6171e88825ea4054629624be699752dbf4608a69bacb8b8bb738.png" src="_images/023f350e65cb6171e88825ea4054629624be699752dbf4608a69bacb8b8bb738.png" />
</div>
</div>
</section>
<section id="earnings-estimates">
<h3>Earnings Estimates<a class="headerlink" href="#earnings-estimates" title="Permalink to this heading">#</a></h3>
<p>Earnings estimate signals are drawn from IBES data, including fiscal year 1 projections, long-term growth forecasts, and announcement dates linked to CRSP daily prices and Compustat quarterly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chfeps&#39;</span><span class="p">,</span> <span class="s1">&#39;chnanalyst&#39;</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">,</span> <span class="s1">&#39;medest&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;meanest IS NOT NULL &quot;</span>
                            <span class="s2">&quot;  AND fpedats IS NOT NULL &quot;</span>
                            <span class="s2">&quot;  AND statpers IS NOT NULL&quot;</span>
                            <span class="s2">&quot;  AND fpi = &#39;1&#39;&quot;</span><span class="p">))</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag1</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag1</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>        
<span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;chfeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag3</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f3</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag3</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;chnanalyst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 3/3 [03:39&lt;00:00, 73.25s/it]
</pre></div>
</div>
<img alt="_images/71f8cbf860911b691a51cd1c398451089fa53223d07908bc489a15ac2e5e7d29.png" src="_images/71f8cbf860911b691a51cd1c398451089fa53223d07908bc489a15ac2e5e7d29.png" />
<img alt="_images/9853623f04ced746515416a771c29baecb43f096c92eaaec5fa2ffd4474263a9.png" src="_images/9853623f04ced746515416a771c29baecb43f096c92eaaec5fa2ffd4474263a9.png" />
<img alt="_images/51dd81ac127e3e49a36447bfe50ad774919b215336997b92f2f6be6ced71935f.png" src="_images/51dd81ac127e3e49a36447bfe50ad774919b215336997b92f2f6be6ced71935f.png" />
</div>
</div>
<p>IBES Long-term Growth signals</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fgr5yr&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;meanest IS NOT NULL &quot;</span>
                            <span class="s2">&quot;  AND fpi = &#39;0&#39;&quot;</span>
                            <span class="s2">&quot;  AND statpers IS NOT NULL&quot;</span><span class="p">))</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;fgr5yr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span>
<span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;fgr5yr&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1319938
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [01:06&lt;00:00, 66.27s/it]
</pre></div>
</div>
<img alt="_images/50fd4183d154b98beab6ed647c4eb5a92f23950669e8fc51cdb59d981739f153.png" src="_images/50fd4183d154b98beab6ed647c4eb5a92f23950669e8fc51cdb59d981739f153.png" />
</div>
</div>
<p>Announcement date in Quarterly, linked to CRSP daily</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="s1">&#39;aeavol&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve rdq, and set rebalance date to at least one month delay</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;rdq &gt; 0&#39;</span><span class="p">))</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ear is compounded return around 3-day window</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                      <span class="n">field</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                      <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                      <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                      <span class="n">left</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># aeavol is avg volume in 3-day window over 20-day average ten-days prior</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                         <span class="n">field</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span>
                         <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                         <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                         <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                         <span class="n">left</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">normal</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                         <span class="n">field</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span>
                         <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                         <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                         <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                         <span class="n">left</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span>
                         <span class="n">right</span><span class="o">=-</span><span class="mi">11</span><span class="p">,</span>
                         <span class="n">avg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aeavol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="s1">&#39;aeavol&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>968315
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 2/2 [02:07&lt;00:00, 63.88s/it]
</pre></div>
</div>
<img alt="_images/30206dda368fdc8a5e0942f32c5ac6b80f3f4b2b88ad143c453acc2c175071ce.png" src="_images/30206dda368fdc8a5e0942f32c5ac6b80f3f4b2b88ad143c453acc2c175071ce.png" />
<img alt="_images/02d109701773dfbfda6efe337e3559d6b1b8ef05bfa984cc64ff781cd24710c4.png" src="_images/02d109701773dfbfda6efe337e3559d6b1b8ef05bfa984cc64ff781cd24710c4.png" />
</div>
</div>
<p>IBES Fiscal Year 1 linked to Quarterly PSTAT</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">monthnum</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">((</span><span class="n">d</span><span class="o">//</span><span class="mi">10000</span><span class="p">)</span><span class="o">-</span><span class="mi">1900</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="p">((</span><span class="n">d</span><span class="o">//</span><span class="mi">100</span><span class="p">)</span><span class="o">%</span><span class="k">100</span>) - 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
       <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
       <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="s2">&quot;fpi=&#39;1&#39;&quot;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;monthnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthnum</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;monthnum&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># match ibes statpers to any datadate in last 4 mos</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;monthnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthnum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">num</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;monthnum&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">])</span>

    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;sfeq&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>IBES Fiscal Year 1 linked to IBES price history</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve monthly price history</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;actpsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>\
         <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve monthly FY1 mean estimate</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="s2">&quot;fpi=&#39;1&#39; AND statpers &lt;= fpedats&quot;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># join on [permno, statpers], and reindex on [permno, rebaldate]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="s1">&#39;sfe&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sfe&#39;</span>
<span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">,</span>
                            <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                            <span class="n">rebalbeg</span><span class="p">,</span>
                            <span class="n">rebalend</span><span class="p">,</span>
                            <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                            <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                           <span class="n">monthly</span><span class="p">,</span>
                           <span class="n">holdings</span><span class="p">,</span>
                           <span class="n">label</span><span class="p">,</span>
                           <span class="n">benchnames</span><span class="p">,</span>
                           <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> 
                           <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/69dc96f57e12324ec546ff9a1255a962eaea476b74f73286f8caaee1ef20c45c.png" src="_images/69dc96f57e12324ec546ff9a1255a962eaea476b74f73286f8caaee1ef20c45c.png" />
</div>
</div>
<p>IBES Fiscal Quarter 1, linked to Quarterly</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span>
<span class="n">numlag</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve quarterly, keep [permno, datadate] key with non null prccq</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">,</span> <span class="s1">&#39;cshoq&#39;</span><span class="p">,</span> <span class="s1">&#39;ibq&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">)</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;cshoq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">],</span> <span class="n">numlag</span><span class="p">)</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve ibes Q1 where forecast period &lt;= fiscal date, keep latest</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;medest&#39;</span><span class="p">,</span> <span class="s1">&#39;actual&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="s2">&quot; fpi = &#39;6&#39; AND statpers &lt;= fpedats&quot;</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="n">summ</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">],</span> <span class="n">numlag</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve ibes price, then left join</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;actpsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
           <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">])</span>\
           <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sue with ibes surprise and price</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;medest&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sue with ibes surprice and compustat quarterly price</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;medest&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sue with lag(4) difference in compustat quarterly and price</span>
<span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]),</span>
    <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cshoq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;sue&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1089089
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [01:14&lt;00:00, 74.37s/it]
</pre></div>
</div>
<img alt="_images/917ae314241f7a788e9998e0219b1fe51b86c6173efa139540b36f71757ac701.png" src="_images/917ae314241f7a788e9998e0219b1fe51b86c6173efa139540b36f71757ac701.png" />
</div>
</div>
</section>
<section id="backtests">
<h3>Backtests<a class="headerlink" href="#backtests" title="Permalink to this heading">#</a></h3>
<p>All backtests are conducted on univariate, dollar-neutral spreads between the top and bottom deciles of a given characteristic. Stocks are value-weighted within each decile, excluding the smallest quintile of NYSE-listed firms by market capitalization. Spread portfolios are rebalanced monthly, with fundamental data lagged in the standard manner—six months for annual data and four months for quarterly data.</p>
<p>Each backtest generates a time series of cumulative spread portfolio and market index returns, along with metrics such as monthly turnover rates and the number of long and short positions. Results are ranked based on Welch’s <em>t</em>-statistic, which tests for differences in mean returns before 2002 and after 2003. This aligns with findings from Green et al. (2017) and others, who observed a significant decline in the predictive power of many factors after this period.</p>
<p>Additionally, we compute the <strong>maximum drawdown</strong> for each strategy, defined as the largest peak-to-trough loss in cumulative returns before a new peak is reached. This measure provides insight into the worst-case historical performance of each strategy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">maximum_drawdown</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">is_price_level</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute max drawdown (max loss from previous high) period and returns&quot;&quot;&quot;</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">cummax</span> <span class="o">=</span> <span class="n">cumsum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">cummax</span> <span class="o">-</span> <span class="n">cumsum</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">beg</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">[</span><span class="n">cumsum</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zoo</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;begret&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">])</span>
<span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">zoo</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">perf</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">])}</span>
    <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span>
    <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maximum_drawdown</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;excess&#39;</span><span class="p">])</span>
    <span class="n">post</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">],</span>
                                <span class="n">beg</span><span class="o">=</span><span class="mi">20020101</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>
    <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;(-)&#39;</span> <span class="k">if</span> <span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="c1">#            &#39;Start&#39;: excess[&#39;ret&#39;].index[0],</span>
        <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;sharpe&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Appraisal Ratio&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;appraisal&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Avg Ret&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;Vol&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;Welch-t&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;welch-t&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Appraisal2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;appraisal&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Ret2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;Drawdown&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Welch-t&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_colwidth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">df</span> <span class="c1">#.sort_values(&#39;Sharpe Ratio&#39;, ascending=False)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sharpe Ratio</th>
      <th>Alpha</th>
      <th>Appraisal Ratio</th>
      <th>Avg Ret</th>
      <th>Vol</th>
      <th>Welch-t</th>
      <th>Appraisal2002</th>
      <th>Ret2002</th>
      <th>Drawdown</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pchsale_pchrect</th>
      <td>-0.1169</td>
      <td>-0.0121</td>
      <td>-0.1368</td>
      <td>-0.0009</td>
      <td>0.0256</td>
      <td>-3.1904</td>
      <td>-0.6200</td>
      <td>-0.0047</td>
      <td>-0.8591</td>
    </tr>
    <tr>
      <th>mom1m(-)</th>
      <td>0.3820</td>
      <td>0.0568</td>
      <td>0.3132</td>
      <td>0.0061</td>
      <td>0.0543</td>
      <td>-2.7253</td>
      <td>-0.3205</td>
      <td>-0.0017</td>
      <td>-0.7606</td>
    </tr>
    <tr>
      <th>bm</th>
      <td>0.2233</td>
      <td>0.0339</td>
      <td>0.2141</td>
      <td>0.0029</td>
      <td>0.0457</td>
      <td>-2.3167</td>
      <td>-0.3007</td>
      <td>-0.0019</td>
      <td>-0.7651</td>
    </tr>
    <tr>
      <th>bm_ia</th>
      <td>0.2413</td>
      <td>0.0216</td>
      <td>0.1611</td>
      <td>0.0027</td>
      <td>0.0393</td>
      <td>-2.2583</td>
      <td>-0.2118</td>
      <td>-0.0012</td>
      <td>-0.7011</td>
    </tr>
    <tr>
      <th>agr(-)</th>
      <td>0.2493</td>
      <td>0.0480</td>
      <td>0.4320</td>
      <td>0.0025</td>
      <td>0.0341</td>
      <td>-2.1174</td>
      <td>0.0200</td>
      <td>-0.0008</td>
      <td>-0.5362</td>
    </tr>
    <tr>
      <th>pchsale_pchinvt</th>
      <td>0.2434</td>
      <td>0.0229</td>
      <td>0.2392</td>
      <td>0.0019</td>
      <td>0.0276</td>
      <td>-2.1010</td>
      <td>-0.1343</td>
      <td>-0.0008</td>
      <td>-0.4944</td>
    </tr>
    <tr>
      <th>chmom</th>
      <td>0.4007</td>
      <td>0.0509</td>
      <td>0.3114</td>
      <td>0.0058</td>
      <td>0.0494</td>
      <td>-1.9158</td>
      <td>-0.0634</td>
      <td>0.0010</td>
      <td>-0.6159</td>
    </tr>
    <tr>
      <th>pchsaleinv</th>
      <td>0.2446</td>
      <td>0.0197</td>
      <td>0.2238</td>
      <td>0.0018</td>
      <td>0.0254</td>
      <td>-1.7332</td>
      <td>-0.1297</td>
      <td>-0.0003</td>
      <td>-0.4843</td>
    </tr>
    <tr>
      <th>lev</th>
      <td>0.0261</td>
      <td>-0.0002</td>
      <td>-0.0012</td>
      <td>0.0004</td>
      <td>0.0488</td>
      <td>-1.6920</td>
      <td>-0.3338</td>
      <td>-0.0035</td>
      <td>-0.8698</td>
    </tr>
    <tr>
      <th>absacc(-)</th>
      <td>0.0380</td>
      <td>0.0212</td>
      <td>0.1520</td>
      <td>0.0005</td>
      <td>0.0414</td>
      <td>-1.6578</td>
      <td>-0.1800</td>
      <td>-0.0027</td>
      <td>-0.7840</td>
    </tr>
    <tr>
      <th>ep</th>
      <td>0.2831</td>
      <td>0.0639</td>
      <td>0.4231</td>
      <td>0.0037</td>
      <td>0.0452</td>
      <td>-1.4698</td>
      <td>0.2254</td>
      <td>0.0007</td>
      <td>-0.6637</td>
    </tr>
    <tr>
      <th>chcsho(-)</th>
      <td>0.5415</td>
      <td>0.0725</td>
      <td>0.7490</td>
      <td>0.0047</td>
      <td>0.0298</td>
      <td>-1.4605</td>
      <td>0.5437</td>
      <td>0.0027</td>
      <td>-0.3253</td>
    </tr>
    <tr>
      <th>invest(-)</th>
      <td>0.2479</td>
      <td>0.0450</td>
      <td>0.3776</td>
      <td>0.0025</td>
      <td>0.0356</td>
      <td>-1.3936</td>
      <td>0.1366</td>
      <td>0.0001</td>
      <td>-0.4268</td>
    </tr>
    <tr>
      <th>acc(-)</th>
      <td>0.3358</td>
      <td>0.0377</td>
      <td>0.3500</td>
      <td>0.0030</td>
      <td>0.0312</td>
      <td>-1.3486</td>
      <td>0.0828</td>
      <td>0.0011</td>
      <td>-0.3966</td>
    </tr>
    <tr>
      <th>indmom</th>
      <td>0.3518</td>
      <td>0.0643</td>
      <td>0.3708</td>
      <td>0.0053</td>
      <td>0.0512</td>
      <td>-1.3305</td>
      <td>0.2007</td>
      <td>0.0020</td>
      <td>-0.6892</td>
    </tr>
    <tr>
      <th>sp</th>
      <td>0.2303</td>
      <td>0.0329</td>
      <td>0.2220</td>
      <td>0.0028</td>
      <td>0.0428</td>
      <td>-1.2746</td>
      <td>-0.0372</td>
      <td>0.0004</td>
      <td>-0.5726</td>
    </tr>
    <tr>
      <th>pchdepr</th>
      <td>0.0617</td>
      <td>0.0048</td>
      <td>0.0506</td>
      <td>0.0005</td>
      <td>0.0273</td>
      <td>-1.2651</td>
      <td>-0.1436</td>
      <td>-0.0011</td>
      <td>-0.6979</td>
    </tr>
    <tr>
      <th>egr(-)</th>
      <td>0.3157</td>
      <td>0.0539</td>
      <td>0.5072</td>
      <td>0.0030</td>
      <td>0.0327</td>
      <td>-1.2025</td>
      <td>0.3026</td>
      <td>0.0013</td>
      <td>-0.3384</td>
    </tr>
    <tr>
      <th>sgrvol</th>
      <td>0.1918</td>
      <td>0.0082</td>
      <td>0.0562</td>
      <td>0.0024</td>
      <td>0.0440</td>
      <td>-1.1672</td>
      <td>-0.2804</td>
      <td>0.0001</td>
      <td>-0.6935</td>
    </tr>
    <tr>
      <th>mom12m</th>
      <td>0.4699</td>
      <td>0.1532</td>
      <td>0.6550</td>
      <td>0.0101</td>
      <td>0.0732</td>
      <td>-1.1488</td>
      <td>0.5282</td>
      <td>0.0058</td>
      <td>-0.9670</td>
    </tr>
    <tr>
      <th>realestate</th>
      <td>0.1084</td>
      <td>0.0508</td>
      <td>0.3445</td>
      <td>0.0014</td>
      <td>0.0458</td>
      <td>-1.1485</td>
      <td>0.2426</td>
      <td>-0.0007</td>
      <td>-0.6426</td>
    </tr>
    <tr>
      <th>mom36m(-)</th>
      <td>0.1778</td>
      <td>0.0191</td>
      <td>0.0953</td>
      <td>0.0031</td>
      <td>0.0601</td>
      <td>-1.0582</td>
      <td>-0.0673</td>
      <td>-0.0000</td>
      <td>-0.7280</td>
    </tr>
    <tr>
      <th>cashpr(-)</th>
      <td>0.2962</td>
      <td>0.0475</td>
      <td>0.3843</td>
      <td>0.0031</td>
      <td>0.0363</td>
      <td>-1.0456</td>
      <td>0.0969</td>
      <td>0.0014</td>
      <td>-0.4235</td>
    </tr>
    <tr>
      <th>divyld</th>
      <td>-0.0470</td>
      <td>0.0377</td>
      <td>0.2455</td>
      <td>-0.0008</td>
      <td>0.0552</td>
      <td>-1.0071</td>
      <td>-0.1090</td>
      <td>-0.0032</td>
      <td>-0.9650</td>
    </tr>
    <tr>
      <th>aeavol(-)</th>
      <td>0.2160</td>
      <td>0.0381</td>
      <td>0.3568</td>
      <td>0.0020</td>
      <td>0.0320</td>
      <td>-0.9899</td>
      <td>0.2019</td>
      <td>0.0006</td>
      <td>-0.5583</td>
    </tr>
    <tr>
      <th>ill(-)</th>
      <td>0.3323</td>
      <td>0.0504</td>
      <td>0.4209</td>
      <td>0.0034</td>
      <td>0.0350</td>
      <td>-0.8358</td>
      <td>0.4068</td>
      <td>0.0022</td>
      <td>-0.6150</td>
    </tr>
    <tr>
      <th>dy</th>
      <td>-0.0473</td>
      <td>0.0382</td>
      <td>0.2262</td>
      <td>-0.0008</td>
      <td>0.0569</td>
      <td>-0.7118</td>
      <td>-0.0399</td>
      <td>-0.0025</td>
      <td>-0.9190</td>
    </tr>
    <tr>
      <th>chatoia</th>
      <td>0.2567</td>
      <td>0.0292</td>
      <td>0.2994</td>
      <td>0.0021</td>
      <td>0.0282</td>
      <td>-0.6699</td>
      <td>0.1768</td>
      <td>0.0012</td>
      <td>-0.5082</td>
    </tr>
    <tr>
      <th>chinv(-)</th>
      <td>0.3601</td>
      <td>0.0506</td>
      <td>0.4775</td>
      <td>0.0033</td>
      <td>0.0314</td>
      <td>-0.6658</td>
      <td>0.2930</td>
      <td>0.0023</td>
      <td>-0.2747</td>
    </tr>
    <tr>
      <th>retvol(-)</th>
      <td>0.1306</td>
      <td>0.1269</td>
      <td>0.6067</td>
      <td>0.0029</td>
      <td>0.0772</td>
      <td>-0.6457</td>
      <td>0.5100</td>
      <td>0.0009</td>
      <td>-0.7990</td>
    </tr>
    <tr>
      <th>maxret(-)</th>
      <td>0.1807</td>
      <td>0.1144</td>
      <td>0.6383</td>
      <td>0.0034</td>
      <td>0.0646</td>
      <td>-0.6188</td>
      <td>0.5778</td>
      <td>0.0017</td>
      <td>-0.7173</td>
    </tr>
    <tr>
      <th>pricedelay(-)</th>
      <td>0.0819</td>
      <td>0.0030</td>
      <td>0.0302</td>
      <td>0.0007</td>
      <td>0.0292</td>
      <td>-0.5810</td>
      <td>-0.1441</td>
      <td>-0.0002</td>
      <td>-0.6155</td>
    </tr>
    <tr>
      <th>chfeps</th>
      <td>0.4741</td>
      <td>0.0673</td>
      <td>0.5567</td>
      <td>0.0048</td>
      <td>0.0353</td>
      <td>-0.5669</td>
      <td>0.5971</td>
      <td>0.0040</td>
      <td>-0.2969</td>
    </tr>
    <tr>
      <th>stdcf(-)</th>
      <td>0.2132</td>
      <td>0.0613</td>
      <td>0.5020</td>
      <td>0.0024</td>
      <td>0.0391</td>
      <td>-0.5562</td>
      <td>0.4330</td>
      <td>0.0015</td>
      <td>-0.4787</td>
    </tr>
    <tr>
      <th>idiovol(-)</th>
      <td>-0.0126</td>
      <td>0.0514</td>
      <td>0.2623</td>
      <td>-0.0003</td>
      <td>0.0697</td>
      <td>-0.4946</td>
      <td>0.3285</td>
      <td>-0.0021</td>
      <td>-0.9875</td>
    </tr>
    <tr>
      <th>mve_ia(-)</th>
      <td>0.1372</td>
      <td>0.0025</td>
      <td>0.0244</td>
      <td>0.0012</td>
      <td>0.0302</td>
      <td>-0.4777</td>
      <td>-0.0749</td>
      <td>0.0005</td>
      <td>-0.5605</td>
    </tr>
    <tr>
      <th>chpmia</th>
      <td>0.1598</td>
      <td>0.0266</td>
      <td>0.2003</td>
      <td>0.0018</td>
      <td>0.0385</td>
      <td>-0.4676</td>
      <td>0.1088</td>
      <td>0.0009</td>
      <td>-0.6303</td>
    </tr>
    <tr>
      <th>disp(-)</th>
      <td>0.3267</td>
      <td>0.1025</td>
      <td>0.6640</td>
      <td>0.0048</td>
      <td>0.0508</td>
      <td>-0.3850</td>
      <td>0.7927</td>
      <td>0.0039</td>
      <td>-0.5300</td>
    </tr>
    <tr>
      <th>cfp</th>
      <td>0.2466</td>
      <td>0.0511</td>
      <td>0.3691</td>
      <td>0.0029</td>
      <td>0.0412</td>
      <td>-0.3045</td>
      <td>0.2216</td>
      <td>0.0024</td>
      <td>-0.5708</td>
    </tr>
    <tr>
      <th>stdacc(-)</th>
      <td>0.1414</td>
      <td>0.0431</td>
      <td>0.3801</td>
      <td>0.0014</td>
      <td>0.0354</td>
      <td>-0.2576</td>
      <td>0.3357</td>
      <td>0.0011</td>
      <td>-0.5056</td>
    </tr>
    <tr>
      <th>pchsale_pchxsga</th>
      <td>-0.0415</td>
      <td>-0.0053</td>
      <td>-0.0480</td>
      <td>-0.0004</td>
      <td>0.0320</td>
      <td>-0.2270</td>
      <td>-0.1208</td>
      <td>-0.0007</td>
      <td>-0.7740</td>
    </tr>
    <tr>
      <th>grltnoa</th>
      <td>0.1595</td>
      <td>0.0208</td>
      <td>0.1793</td>
      <td>0.0015</td>
      <td>0.0335</td>
      <td>-0.2164</td>
      <td>0.1620</td>
      <td>0.0012</td>
      <td>-0.5122</td>
    </tr>
    <tr>
      <th>sfe</th>
      <td>0.2535</td>
      <td>0.0763</td>
      <td>0.4340</td>
      <td>0.0039</td>
      <td>0.0532</td>
      <td>-0.1952</td>
      <td>0.3435</td>
      <td>0.0034</td>
      <td>-0.7417</td>
    </tr>
    <tr>
      <th>pchgm_pchsale</th>
      <td>0.0106</td>
      <td>-0.0035</td>
      <td>-0.0337</td>
      <td>0.0001</td>
      <td>0.0297</td>
      <td>-0.1935</td>
      <td>0.0227</td>
      <td>-0.0002</td>
      <td>-0.5895</td>
    </tr>
    <tr>
      <th>cfp_ia</th>
      <td>-0.1814</td>
      <td>-0.0331</td>
      <td>-0.2501</td>
      <td>-0.0020</td>
      <td>0.0386</td>
      <td>-0.1337</td>
      <td>-0.3944</td>
      <td>-0.0022</td>
      <td>-0.8613</td>
    </tr>
    <tr>
      <th>mom6m</th>
      <td>0.3185</td>
      <td>0.1085</td>
      <td>0.5001</td>
      <td>0.0064</td>
      <td>0.0682</td>
      <td>-0.1285</td>
      <td>0.5223</td>
      <td>0.0060</td>
      <td>-0.9885</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>0.0807</td>
      <td>-0.0733</td>
      <td>-0.3806</td>
      <td>0.0022</td>
      <td>0.0906</td>
      <td>-0.1225</td>
      <td>-0.4818</td>
      <td>0.0016</td>
      <td>-0.9586</td>
    </tr>
    <tr>
      <th>dolvol</th>
      <td>0.1131</td>
      <td>0.0017</td>
      <td>0.0161</td>
      <td>0.0010</td>
      <td>0.0315</td>
      <td>-0.1030</td>
      <td>0.1331</td>
      <td>0.0009</td>
      <td>-0.7624</td>
    </tr>
    <tr>
      <th>nincr</th>
      <td>0.3410</td>
      <td>0.0242</td>
      <td>0.2728</td>
      <td>0.0026</td>
      <td>0.0259</td>
      <td>-0.0929</td>
      <td>0.3654</td>
      <td>0.0024</td>
      <td>-0.4061</td>
    </tr>
    <tr>
      <th>cinvest(-)</th>
      <td>-0.4026</td>
      <td>-0.0447</td>
      <td>-0.3815</td>
      <td>-0.0039</td>
      <td>0.0339</td>
      <td>0.0387</td>
      <td>-0.3699</td>
      <td>-0.0039</td>
      <td>-0.9587</td>
    </tr>
    <tr>
      <th>cash</th>
      <td>0.2751</td>
      <td>0.0143</td>
      <td>0.1021</td>
      <td>0.0035</td>
      <td>0.0438</td>
      <td>0.0479</td>
      <td>0.0796</td>
      <td>0.0036</td>
      <td>-0.7076</td>
    </tr>
    <tr>
      <th>chtx</th>
      <td>0.2162</td>
      <td>0.0211</td>
      <td>0.1716</td>
      <td>0.0022</td>
      <td>0.0358</td>
      <td>0.1783</td>
      <td>0.3262</td>
      <td>0.0025</td>
      <td>-0.4779</td>
    </tr>
    <tr>
      <th>salecash</th>
      <td>0.0170</td>
      <td>0.0199</td>
      <td>0.1773</td>
      <td>0.0002</td>
      <td>0.0342</td>
      <td>0.2132</td>
      <td>0.2326</td>
      <td>0.0005</td>
      <td>-0.7463</td>
    </tr>
    <tr>
      <th>rd_mve</th>
      <td>0.1412</td>
      <td>0.0114</td>
      <td>0.0716</td>
      <td>0.0019</td>
      <td>0.0463</td>
      <td>0.2541</td>
      <td>0.0853</td>
      <td>0.0024</td>
      <td>-0.7868</td>
    </tr>
    <tr>
      <th>chnanalyst</th>
      <td>0.0875</td>
      <td>0.0021</td>
      <td>0.0240</td>
      <td>0.0006</td>
      <td>0.0255</td>
      <td>0.2806</td>
      <td>0.1425</td>
      <td>0.0010</td>
      <td>-0.5443</td>
    </tr>
    <tr>
      <th>fgr5yr</th>
      <td>0.0537</td>
      <td>-0.0485</td>
      <td>-0.2487</td>
      <td>0.0010</td>
      <td>0.0640</td>
      <td>0.3620</td>
      <td>-0.0030</td>
      <td>0.0020</td>
      <td>-0.8761</td>
    </tr>
    <tr>
      <th>sue</th>
      <td>0.4709</td>
      <td>0.0557</td>
      <td>0.5087</td>
      <td>0.0043</td>
      <td>0.0317</td>
      <td>0.3800</td>
      <td>0.6849</td>
      <td>0.0048</td>
      <td>-0.4062</td>
    </tr>
    <tr>
      <th>pchcapx_ia</th>
      <td>-0.1942</td>
      <td>-0.0262</td>
      <td>-0.2113</td>
      <td>-0.0020</td>
      <td>0.0359</td>
      <td>0.4287</td>
      <td>-0.0762</td>
      <td>-0.0013</td>
      <td>-0.8750</td>
    </tr>
    <tr>
      <th>roavol</th>
      <td>0.0768</td>
      <td>-0.0063</td>
      <td>-0.0425</td>
      <td>0.0010</td>
      <td>0.0440</td>
      <td>0.4640</td>
      <td>0.0964</td>
      <td>0.0019</td>
      <td>-0.7812</td>
    </tr>
    <tr>
      <th>baspread</th>
      <td>-0.0851</td>
      <td>-0.1231</td>
      <td>-0.5790</td>
      <td>-0.0020</td>
      <td>0.0804</td>
      <td>0.4727</td>
      <td>-0.5203</td>
      <td>-0.0005</td>
      <td>-0.9539</td>
    </tr>
    <tr>
      <th>pchquick</th>
      <td>-0.0755</td>
      <td>-0.0085</td>
      <td>-0.0918</td>
      <td>-0.0006</td>
      <td>0.0268</td>
      <td>0.5811</td>
      <td>-0.0879</td>
      <td>0.0001</td>
      <td>-0.7586</td>
    </tr>
    <tr>
      <th>rd_sale</th>
      <td>-0.0530</td>
      <td>-0.0146</td>
      <td>-0.0945</td>
      <td>-0.0007</td>
      <td>0.0446</td>
      <td>0.6114</td>
      <td>-0.0313</td>
      <td>0.0005</td>
      <td>-0.8706</td>
    </tr>
    <tr>
      <th>pctacc(-)</th>
      <td>0.1174</td>
      <td>0.0248</td>
      <td>0.2364</td>
      <td>0.0011</td>
      <td>0.0312</td>
      <td>0.6117</td>
      <td>0.2568</td>
      <td>0.0019</td>
      <td>-0.3803</td>
    </tr>
    <tr>
      <th>secured(-)</th>
      <td>0.0364</td>
      <td>0.0337</td>
      <td>0.2793</td>
      <td>0.0004</td>
      <td>0.0376</td>
      <td>0.6222</td>
      <td>0.3922</td>
      <td>0.0014</td>
      <td>-0.6406</td>
    </tr>
    <tr>
      <th>std_turn</th>
      <td>0.0539</td>
      <td>-0.0490</td>
      <td>-0.2884</td>
      <td>0.0009</td>
      <td>0.0582</td>
      <td>0.6391</td>
      <td>-0.2285</td>
      <td>0.0024</td>
      <td>-0.8064</td>
    </tr>
    <tr>
      <th>std_dolvol</th>
      <td>-0.0176</td>
      <td>0.0007</td>
      <td>0.0068</td>
      <td>-0.0002</td>
      <td>0.0315</td>
      <td>0.7879</td>
      <td>0.0782</td>
      <td>0.0008</td>
      <td>-0.5301</td>
    </tr>
    <tr>
      <th>rsup</th>
      <td>0.1644</td>
      <td>0.0237</td>
      <td>0.1859</td>
      <td>0.0018</td>
      <td>0.0369</td>
      <td>0.8444</td>
      <td>0.4582</td>
      <td>0.0032</td>
      <td>-0.5353</td>
    </tr>
    <tr>
      <th>depr</th>
      <td>0.0696</td>
      <td>-0.0201</td>
      <td>-0.1534</td>
      <td>0.0008</td>
      <td>0.0422</td>
      <td>0.8697</td>
      <td>0.0616</td>
      <td>0.0024</td>
      <td>-0.6522</td>
    </tr>
    <tr>
      <th>zerotrade(-)</th>
      <td>0.1663</td>
      <td>-0.0351</td>
      <td>-0.1939</td>
      <td>0.0031</td>
      <td>0.0644</td>
      <td>0.8812</td>
      <td>-0.0779</td>
      <td>0.0054</td>
      <td>-0.8344</td>
    </tr>
    <tr>
      <th>sgr</th>
      <td>0.0225</td>
      <td>-0.0138</td>
      <td>-0.1111</td>
      <td>0.0002</td>
      <td>0.0372</td>
      <td>0.9168</td>
      <td>0.0682</td>
      <td>0.0018</td>
      <td>-0.7062</td>
    </tr>
    <tr>
      <th>salerec</th>
      <td>0.2028</td>
      <td>0.0405</td>
      <td>0.3172</td>
      <td>0.0022</td>
      <td>0.0378</td>
      <td>0.9547</td>
      <td>0.5194</td>
      <td>0.0040</td>
      <td>-0.6761</td>
    </tr>
    <tr>
      <th>roaq</th>
      <td>0.2858</td>
      <td>0.0610</td>
      <td>0.4358</td>
      <td>0.0035</td>
      <td>0.0422</td>
      <td>0.9856</td>
      <td>0.7546</td>
      <td>0.0054</td>
      <td>-0.4532</td>
    </tr>
    <tr>
      <th>turn</th>
      <td>0.1420</td>
      <td>-0.0412</td>
      <td>-0.2184</td>
      <td>0.0027</td>
      <td>0.0669</td>
      <td>0.9945</td>
      <td>-0.0831</td>
      <td>0.0054</td>
      <td>-0.8291</td>
    </tr>
    <tr>
      <th>ear</th>
      <td>0.1909</td>
      <td>-0.0019</td>
      <td>-0.0185</td>
      <td>0.0018</td>
      <td>0.0329</td>
      <td>1.0453</td>
      <td>0.2661</td>
      <td>0.0033</td>
      <td>-0.5423</td>
    </tr>
    <tr>
      <th>quick</th>
      <td>0.0603</td>
      <td>-0.0241</td>
      <td>-0.1670</td>
      <td>0.0008</td>
      <td>0.0467</td>
      <td>1.2014</td>
      <td>0.0018</td>
      <td>0.0033</td>
      <td>-0.7923</td>
    </tr>
    <tr>
      <th>gma</th>
      <td>0.1117</td>
      <td>0.0201</td>
      <td>0.1363</td>
      <td>0.0014</td>
      <td>0.0426</td>
      <td>1.2529</td>
      <td>0.4330</td>
      <td>0.0039</td>
      <td>-0.6364</td>
    </tr>
    <tr>
      <th>hire</th>
      <td>-0.1215</td>
      <td>-0.0324</td>
      <td>-0.2790</td>
      <td>-0.0012</td>
      <td>0.0353</td>
      <td>1.4328</td>
      <td>0.0264</td>
      <td>0.0011</td>
      <td>-0.8262</td>
    </tr>
    <tr>
      <th>tang</th>
      <td>0.2328</td>
      <td>0.0149</td>
      <td>0.1259</td>
      <td>0.0024</td>
      <td>0.0351</td>
      <td>1.4843</td>
      <td>0.3043</td>
      <td>0.0047</td>
      <td>-0.7361</td>
    </tr>
    <tr>
      <th>grcapx</th>
      <td>-0.2991</td>
      <td>-0.0421</td>
      <td>-0.4188</td>
      <td>-0.0026</td>
      <td>0.0298</td>
      <td>1.5208</td>
      <td>-0.1320</td>
      <td>-0.0004</td>
      <td>-0.8714</td>
    </tr>
    <tr>
      <th>saleinv</th>
      <td>0.1401</td>
      <td>0.0364</td>
      <td>0.3711</td>
      <td>0.0013</td>
      <td>0.0312</td>
      <td>1.9087</td>
      <td>0.6251</td>
      <td>0.0040</td>
      <td>-0.4900</td>
    </tr>
    <tr>
      <th>chempia</th>
      <td>0.0698</td>
      <td>-0.0084</td>
      <td>-0.0768</td>
      <td>0.0007</td>
      <td>0.0331</td>
      <td>2.0683</td>
      <td>0.3022</td>
      <td>0.0038</td>
      <td>-0.7319</td>
    </tr>
    <tr>
      <th>lgr</th>
      <td>-0.0573</td>
      <td>-0.0162</td>
      <td>-0.1720</td>
      <td>-0.0005</td>
      <td>0.0279</td>
      <td>2.2177</td>
      <td>0.2295</td>
      <td>0.0024</td>
      <td>-0.8286</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rets</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>   <span class="c1"># standardize to unit variance</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="cluster-analysis">
<h2>Cluster analysis<a class="headerlink" href="#cluster-analysis" title="Permalink to this heading">#</a></h2>
<p>We use historical backtest returns as input features for cluster analysis, enabling the identification of peer benchmarks for different investment strategies. Strategies that exhibit similar return patterns tend to load on the same “style” factors and should be evaluated against one another.</p>
<p>The correlation between two return series is closely related to their Euclidean distance. When returns are standardized to have unit variance, the squared Euclidean norm between two series <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> can be expressed as:</p>
<div class="math notranslate nohighlight">
\[
d^2 = \sum_i (x_i - y_i)^2 = \sum_i x_i^2 + \sum_i y_i^2 - 2 \sum_i x_i y_i = n + n - 2n\rho
\]</div>
<p>since <span class="math notranslate nohighlight">\(\sum_i x_i^2 = \sum_i y_i^2 = n\)</span>, and <span class="math notranslate nohighlight">\(\rho = \sum_i x_i y_i / n\)</span>, where <span class="math notranslate nohighlight">\( \rho \)</span> represents the correlation between the two series. This relationship allows correlation to be rewritten as:</p>
<div class="math notranslate nohighlight">
\[
\rho = 1 - \frac{d^2}{2n}
\]</div>
<section id="hiearchical-clustering">
<h3>Hiearchical clustering<a class="headerlink" href="#hiearchical-clustering" title="Permalink to this heading">#</a></h3>
<p>Hierarchical clustering builds a tree-like structure by iteratively merging clusters based on their similarity. Different linkage methods determine how clusters are merged:</p>
<ul class="simple">
<li><p><strong>Single Linkage</strong>: Merges clusters based on the closest points, leading to elongated clusters.</p></li>
<li><p><strong>Complete Linkage</strong>: Uses the farthest points between clusters, producing compact, spherical clusters.</p></li>
<li><p><strong>Average Linkage</strong>: Merges clusters based on the average distance between all points, balancing between single and complete linkage.</p></li>
<li><p><strong>Ward’s Method</strong>: Minimizes within-cluster variance, resulting in clusters of similar size and shape.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;precomputed&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span>
                                <span class="n">distance_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hierarchical Clustering Dendrogram&quot;</span><span class="p">)</span>
<span class="c1"># Create linkage matrix and then plot the dendrogram</span>
<span class="c1"># scikit-learn: &quot;Plot Hierarchical Clustering Dendrogram&quot;</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">children_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
<span class="c1"># create the counts of samples under each node</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">merge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">children_</span><span class="p">):</span>
    <span class="n">current_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">child_idx</span> <span class="ow">in</span> <span class="n">merge</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">child_idx</span> <span class="o">&lt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">current_count</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># leaf node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_count</span> <span class="o">+=</span> <span class="n">counts</span><span class="p">[</span><span class="n">child_idx</span> <span class="o">-</span> <span class="n">n_samples</span><span class="p">]</span>
    <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_count</span>

<span class="n">linkage_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">children_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">distances_</span><span class="p">,</span> <span class="n">counts</span><span class="p">])</span>\
                   <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="c1"># Plot the corresponding dendrogram</span>
<span class="n">dendrogram</span><span class="p">(</span><span class="n">linkage_matrix</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">leaf_font_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fbd63dc53bc45a747c5a840a813384eeadd47923d00c07f72500be16457f748a.png" src="_images/fbd63dc53bc45a747c5a840a813384eeadd47923d00c07f72500be16457f748a.png" />
</div>
</div>
</section>
<section id="k-means-clustering">
<h3>K-means clustering<a class="headerlink" href="#k-means-clustering" title="Permalink to this heading">#</a></h3>
<p>K-means is a widely used unsupervised learning algorithm that partitions data into <span class="math notranslate nohighlight">\( K \)</span> non-overlapping clusters. The process involves:</p>
<ol class="arabic simple">
<li><p>Selecting an initial number of clusters <span class="math notranslate nohighlight">\( K \)</span>.</p></li>
<li><p>Randomly assigning initial cluster centroids.</p></li>
<li><p>Iteratively assigning each data point to the nearest centroid.</p></li>
<li><p>Recalculating centroids based on the mean of points in each cluster.</p></li>
<li><p>Repeating until convergence.</p></li>
</ol>
<p>K-means minimizes the within-cluster sum of squared distances, making it well-suited for datasets where clusters are roughly spherical and of similar size.</p>
<p><strong>The Elbow Method</strong> is commonly used to determine the optimal number of clusters by plotting the within-cluster sum of squares for different values of <span class="math notranslate nohighlight">\( K \)</span>. The optimal <span class="math notranslate nohighlight">\( K \)</span> is where the graph forms an “elbow,” indicating diminishing returns from adding more clusters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Selecting number of centers with elbow method</span>
<span class="n">inertias</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
<span class="k">for</span> <span class="n">n_cluster</span> <span class="ow">in</span> <span class="n">n_clusters</span><span class="p">:</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">inertias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">inertias</span><span class="p">,</span> <span class="s1">&#39;bx-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of clusters&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Inertia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Elbow Method using Inertia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/af37c84b01415cf48f4b37f8985f7951d724caf9523c70cadcbdf407d115be06.png" src="_images/af37c84b01415cf48f4b37f8985f7951d724caf9523c70cadcbdf407d115be06.png" />
</div>
</div>
<p><strong>Silhouette Analysis</strong> provides an alternative evaluation method by measuring how well-separated clusters are. The silhouette score compares cohesion (similarity within a cluster) to separation (difference from other clusters), with values ranging from -1 to 1. Higher scores indicate better-defined clusters, and the number of clusters maximizing the average silhouette score is considered optimal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scikit-learn: &quot;Selecting the number of clusters with silhouette analysis on KMeans clustering&quot;</span>
<span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">n_cluster</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">clusterer</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># The silhouette_score gives the average value for all the samples.</span>
    <span class="c1"># This gives a perspective into the density and separation of the formed</span>
    <span class="c1"># clusters</span>
    <span class="n">silhouette_avg</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For n_clusters =&quot;</span><span class="p">,</span> <span class="n">n_cluster</span><span class="p">,</span>
          <span class="s2">&quot;The average silhouette_score is :&quot;</span><span class="p">,</span> <span class="n">silhouette_avg</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">[</span><span class="n">n_cluster</span><span class="p">]</span> <span class="o">=</span> <span class="n">silhouette_avg</span>
    <span class="c1"># Compute the silhouette scores for each sample</span>
    <span class="n">sample_silhouette_values</span> <span class="o">=</span> <span class="n">silhouette_samples</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_cluster</span><span class="si">}</span><span class="s2"> clusters: </span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">.4</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cluster</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">])</span>

    <span class="n">y_lower</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cluster</span><span class="p">):</span>
        <span class="c1"># Aggregate the silhouette scores for samples belonging to</span>
        <span class="c1"># cluster i, and sort them</span>
        <span class="n">ith_cluster_silhouette_values</span> <span class="o">=</span> <span class="n">sample_silhouette_values</span><span class="p">[</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">ith_cluster_silhouette_values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">size_cluster_i</span> <span class="o">=</span> <span class="n">ith_cluster_silhouette_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_upper</span> <span class="o">=</span> <span class="n">y_lower</span> <span class="o">+</span> <span class="n">size_cluster_i</span>

        <span class="n">color</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cluster</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">y_upper</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">ith_cluster_silhouette_values</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Label the silhouette plots with their cluster numbers at the middle</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y_lower</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">size_cluster_i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># Compute the new y_lower for next plot</span>
        <span class="n">y_lower</span> <span class="o">=</span> <span class="n">y_upper</span> <span class="o">+</span> <span class="mi">10</span>  <span class="c1"># 10 for the 0 samples</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cluster label&quot;</span><span class="p">)</span>

    <span class="c1"># The vertical line for average silhouette score of all the values</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">silhouette_avg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>  <span class="c1"># Clear the yaxis labels / ticks</span>
<span class="c1">#    ax1.set_xticks([-0.1, 0, 0.2, 0.4, 0.6, 0.8, 1])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Average silouette scores by number of clusters&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For n_clusters = 2 The average silhouette_score is : 0.12182520066378914
For n_clusters = 3 The average silhouette_score is : 0.12298455415373394
For n_clusters = 4 The average silhouette_score is : 0.06615920430551211
For n_clusters = 5 The average silhouette_score is : 0.062263203571522374
For n_clusters = 6 The average silhouette_score is : 0.05360073591339586
For n_clusters = 7 The average silhouette_score is : 0.043399891992264766
For n_clusters = 8 The average silhouette_score is : 0.01865524677198136
For n_clusters = 9 The average silhouette_score is : 0.013274893057161832
For n_clusters = 10 The average silhouette_score is : 0.014055548382794032
For n_clusters = 11 The average silhouette_score is : 0.013559353746117705
For n_clusters = 12 The average silhouette_score is : 0.019298192911994215
For n_clusters = 13 The average silhouette_score is : 0.029625503519344714
For n_clusters = 14 The average silhouette_score is : 0.011439750949169072
For n_clusters = 15 The average silhouette_score is : 0.010659851615184082
For n_clusters = 16 The average silhouette_score is : 0.010407061841623768
For n_clusters = 17 The average silhouette_score is : 0.017270693194767258
For n_clusters = 18 The average silhouette_score is : 0.01369810719820829
For n_clusters = 19 The average silhouette_score is : 0.016630208862778856
For n_clusters = 20 The average silhouette_score is : 0.019144464436508506
For n_clusters = 21 The average silhouette_score is : 0.005561006651677671
For n_clusters = 22 The average silhouette_score is : 0.006354452315559386
For n_clusters = 23 The average silhouette_score is : 0.005722873193904617
For n_clusters = 24 The average silhouette_score is : 0.006108458004688574
For n_clusters = 25 The average silhouette_score is : 0.004737653906771348
For n_clusters = 26 The average silhouette_score is : 0.007702186499322102
For n_clusters = 27 The average silhouette_score is : 0.009876913034750879
For n_clusters = 28 The average silhouette_score is : 0.008628670013359775
For n_clusters = 29 The average silhouette_score is : 0.00908060151674441
For n_clusters = 30 The average silhouette_score is : 0.01149725260958716
For n_clusters = 31 The average silhouette_score is : 0.009230744450581462
</pre></div>
</div>
<img alt="_images/1ce45fbe6f285e7ac92503a9d0682ebae43f755c6ef49a749b36884ef2a5036e.png" src="_images/1ce45fbe6f285e7ac92503a9d0682ebae43f755c6ef49a749b36884ef2a5036e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Series</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Average Silhouette Score by Number of Clusters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: title={&#39;center&#39;: &#39;Average Silhouette Score by Number of Clusters&#39;}&gt;
</pre></div>
</div>
<img alt="_images/943cd8872d80924a8726279c8e1f7232e3aa44e28917cb98e1674e2d650e98a1.png" src="_images/943cd8872d80924a8726279c8e1f7232e3aa44e28917cb98e1674e2d650e98a1.png" />
</div>
</div>
<p><strong>Heatmap of strategy correlations</strong></p>
<p>A heatmap visualizes the distances between strategy returns (y-axis) and their respective cluster centers (x-axis), with clusters determined using the K-Means algorithm (K=20). The darkest-colored values appear along the jagged diagonal, indicating that strategy returns are closest to the centers of their assigned clusters. This visualization aids in identifying common style factors and risk exposures across different investment strategies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">])</span>  <span class="c1"># group by cluster and distance to center</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distance of Factor Returns to Cluster Centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)),</span> <span class="n">labels</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;distance from cluster centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef90d4509cc79fd13dd53bfb18a360239ef01ad389d94b02322d5309da76f2fa.png" src="_images/ef90d4509cc79fd13dd53bfb18a360239ef01ad389d94b02322d5309da76f2fa.png" />
</div>
</div>
<p><strong>References:</strong></p>
<p>Stephen Ross, 1976, “The arbitrage theory of capital asset pricing”, Journal of Economic Theory, Volume 13, Issue 3, December 1976, Pages 341-360</p>
<p>Robert C. Merton, 1973, “An Intertemporal Capital Asset Pricing Model”, Econometrica, Vol. 41, No. 5 (Sep., 1973), pp. 867-887</p>
<p>Jeremiah Green, John R. M. Hand, X. Frank Zhang, 2017, “The Characteristics that Provide Independent Information about Average U.S. Monthly Stock Returns”, The Review of Financial Studies, Volume 30, Issue 12, December 2017, Pages 4389–4436</p>
<p>John H. Cochrane, 2011, “Presidential Address: Discount Rates”, The Journal of Finance, Volume 66, Issue 4, August 2011, Pages 1047-1108</p>
<p>Lo, Andrew W. (2004). “The Adaptive Markets Hypothesis: Market Efficiency from an Evolutionary Perspective”. Journal of Portfolio Management. 5. 30: 15–29</p>
<p>Andrew Lo, 2017, “Adaptive Markets: Financial Evolution at the Speed of Thought”.</p>
<p>Andrew Ang, 2014, “Asset Management: A Systematic Approach to Factor Investing”</p>
<p>FRM Part II Exam Book Investment Manager Ch. 1-3.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="1.5_contrarian_trading.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Contrarian Trading</p>
      </div>
    </a>
    <a class="right-next"
       href="1.7_event_study.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Event Study</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-investing">Factor investing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-markets-hypothesis">Adaptive Markets Hypothesis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-zoo">Factor Zoo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#past-prices">Past prices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity">Liquidity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentals">Fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#earnings-estimates">Earnings Estimates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backtests">Backtests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-analysis">Cluster analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hiearchical-clustering">Hiearchical clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k-means-clustering">K-means clustering</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2020-2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>